<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å Easy ‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { kanit: ['Kanit', 'sans-serif'] }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-50 min-h-screen font-kanit">
  <!-- Branch Selection -->
  <div id="branchScreen" class="min-h-screen flex flex-col">
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 text-center">
      <h1 class="text-2xl font-bold mb-2">üçú Easy ‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å</h1>
      <p class="text-orange-100">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å</p>
    </div>
    <div class="flex-1 p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</h2>
      <div class="space-y-4">
        <button onclick="selectBranch('‡∏≠‡∏°‡∏ï‡∏∞')" class="w-full bg-white rounded-xl p-4 shadow-lg border-2 border-transparent hover:border-orange-300 transition-all duration-200 active:scale-95">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mr-4">üè¢</div>
              <div class="text-left">
                <h3 class="font-semibold text-gray-800">‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏°‡∏ï‡∏∞</h3>
                <p class="text-sm text-gray-500">Amata Branch</p>
              </div>
            </div>
            <span class="text-orange-500 text-xl">‚Üí</span>
          </div>
        </button>

        <button onclick="selectBranch('‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏™‡∏±‡∏à‡∏à‡∏≤')" class="w-full bg-white rounded-xl p-4 shadow-lg border-2 border-transparent hover:border-orange-300 transition-all duration-200 active:scale-95">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">üè™</div>
              <div class="text-left">
                <h3 class="font-semibold text-gray-800">‡∏™‡∏≤‡∏Ç‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏™‡∏±‡∏à‡∏à‡∏≤</h3>
                <p class="text-sm text-gray-500">Prayasatcha Branch</p>
              </div>
            </div>
            <span class="text-orange-500 text-xl">‚Üí</span>
          </div>
        </button>

        <button onclick="selectBranch('‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô')" class="w-full bg-white rounded-xl p-4 shadow-lg border-2 border-transparent hover:border-orange-300 transition-all duration-200 active:scale-95">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">üèñÔ∏è</div>
              <div class="text-left">
                <h3 class="font-semibold text-gray-800">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô</h3>
                <p class="text-sm text-gray-500">Bangsaen Branch</p>
              </div>
            </div>
            <span class="text-orange-500 text-xl">‚Üí</span>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Mode Selection -->
  <div id="modeScreen" class="min-h-screen flex flex-col hidden">
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 text-center relative">
      <button onclick="goBack('branchScreen')" class="absolute left-4 top-6 text-white text-xl">‚Üê</button>
      <h1 class="text-xl font-bold mb-1">‡∏™‡∏≤‡∏Ç‡∏≤ <span id="selectedBranch"></span></h1>
      <p class="text-orange-100">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
    </div>
    <div class="flex-1 p-6">
      <div class="space-y-6">
        <button onclick="selectMode('open')" class="w-full bg-gradient-to-r from-green-400 to-green-500 text-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-200 active:scale-95">
          <div class="text-center">
            <div class="text-4xl mb-3">üîì</div>
            <h3 class="text-xl font-bold">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô</h3>
          </div>
        </button>
        <button onclick="selectMode('close')" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-200 active:scale-95">
          <div class="text-center">
            <div class="text-4xl mb-3">üåô</div>
            <h3 class="text-xl font-bold">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô</h3>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Stock Screen -->
  <div id="stockScreen" class="min-h-screen flex flex-col hidden">
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-4">
      <button onclick="goBack('modeScreen')" class="text-white text-xl mb-2">‚Üê</button>
      <div class="flex justify-between items-center mb-3">
        <div>
          <h1 class="text-lg font-bold">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å</h1>
          <p class="text-orange-100 text-sm"><span id="modeText"></span></p>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold" id="progressText">0%</div>
          <div class="text-xs text-orange-100">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
        </div>
      </div>
      <div class="w-full bg-orange-300 rounded-full h-3">
        <div id="progressBar" class="bg-white h-3 rounded-full transition-all duration-300" style="width:0%"></div>
      </div>
    </div>

    <div class="flex-1 p-4 pb-24" id="stockItems"></div>

    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200">
      <button onclick="saveStock()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-200 active:scale-95">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      </button>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full">
      <div class="text-center">
        <div class="text-4xl mb-4">‚ùì</div>
        <h3 id="confirmModalTitle" class="text-lg font-semibold mb-2">
          ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?
        </h3>
        <p id="confirmItemName" class="text-2xl font-extrabold text-gray-900 tracking-wide mb-6"></p>
        <div class="flex space-x-3">
          <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button onclick="confirmOrder()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg font-medium">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Screen (orders only) -->
  <div id="summaryScreen" class="min-h-screen flex flex-col hidden">
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-4">
      <button onclick="goBack('stockScreen')" class="text-white text-xl mb-2">‚Üê</button>
      <div class="text-center">
        <h1 class="text-lg font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</h1>
        <p class="text-orange-100 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
      </div>
    </div>
    <div class="flex-1 p-4 pb-24">
      <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-4">
        <div class="flex items-center mb-3">
          <span class="text-2xl mr-2">üìã</span>
          <h3 class="text-lg font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</h3>
        </div>
        <div id="orderSummaryList"></div>
      </div>
    </div>
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200">
      <button onclick="confirmSaveStock()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-200 active:scale-95">
        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full">
      <div class="text-center">
        <div class="text-4xl mb-4">‚úÖ</div>
        <h3 class="text-lg font-semibold mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
        <p class="text-gray-600 text-sm mb-6">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</p>
        <button onclick="resetApp()" class="w-full bg-orange-500 text-white py-3 rounded-lg font-medium">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- State ---------------- */
    let currentBranch = '';
    let currentMode = '';
    let stockData = {};
    let orderRequests = {};
    let currentConfirmItem = '';
    let customOrders = [];
    window.currentAction = null; // 'add' | 'remove'
    window.currentCheckbox = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡πä‡∏Å orderOnly

    /* ---------------- Config helpers ---------------- */
    const FRACTIONS = ['', '1/4', '1/2', '3/4']; // ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏®‡∏©
    const WHOLE_MAX = 6; // ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 0‚Äì6

    // ‡πÉ‡∏ä‡πâ hash id ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢/‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥)
    function hashId(name) {
      // FNV-1a 32-bit
      let hash = 0x811c9dc5;
      for (const ch of String(name)) {
        hash ^= ch.codePointAt(0);
        hash = (hash >>> 0) * 16777619 >>> 0;
      }
      return 'orderBtn-' + hash.toString(16);
    }
    function btnIdForItem(name){ return hashId(name); }

    // HTML ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏™‡∏µ‡∏™‡πâ‡∏°/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
    function getOrderBtnHTML(name){
      const id = btnIdForItem(name);
      const ordered = !!orderRequests[name];
      const base = 'px-3 py-2 rounded-lg text-sm font-medium transition-colors';
      const cls = ordered
        ? 'bg-green-500 hover:bg-green-600 text-white ' + base
        : 'bg-orange-500 hover:bg-orange-600 text-white ' + base;
      const label = ordered ? '‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úì' : '‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°';
      return `<button id="${id}" data-item="${name}" onclick="requestOrder('${name}')" class="${cls}">${label}</button>`;
    }
    function refreshOrderButtonState(name){
      const btn = document.getElementById(btnIdForItem(name));
      if (!btn) return;
      const ordered = !!orderRequests[name];
      btn.className = (ordered
        ? 'bg-green-500 hover:bg-green-600 text-white '
        : 'bg-orange-500 hover:bg-orange-600 text-white ')
        + 'px-3 py-2 rounded-lg text-sm font-medium transition-colors';
      btn.textContent = ordered ? '‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úì' : '‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°';
    }

    /* ---------------- Item lists ---------------- */
    // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)
    const openModeItemsBase = [
  { name: '‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏°‡∏µ‡πà', unit: '‡∏´‡πà‡∏≠', type:'fraction' },
  { name: '‡∏≠‡∏Å‡πÑ‡∏Å‡πà', unit: '‡∏Å‡∏¥‡πÇ‡∏•', type:'free' },        // ‚Üê free
  { name: '‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏à‡∏Å', unit: '‡∏ñ‡∏∏‡∏á', type:'fraction' },
  { name: '‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°', unit: '‡∏Å‡∏¥‡πÇ‡∏•', type:'free' },   // ‚Üê free
  { name: '‡∏Å‡∏•‡πà‡∏≠‡∏á 26 oz', unit: '‡πÅ‡∏ñ‡∏ß', type:'fraction' },
  { name: '‡∏Å‡∏•‡πà‡∏≠‡∏á 32 oz', unit: '‡πÅ‡∏ñ‡∏ß', type:'fraction' },
  { name: '‡πÇ‡∏Ñ‡πâ‡∏Å', unit: '‡∏Ç‡∏ß‡∏î', type:'number' },
  { name: '‡∏™‡πÑ‡∏õ‡∏£‡πå‡∏ó', unit: '‡∏Ç‡∏ß‡∏î', type:'number' },
  { name: '‡∏ô‡πâ‡∏≥‡πÅ‡∏î‡∏á', unit: '‡∏Ç‡∏ß‡∏î', type:'number' },
  { name: '‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°', unit: '‡∏Ç‡∏ß‡∏î', type:'number' },
  { name: '‡πÄ‡∏Å‡πä‡∏Å‡∏Æ‡∏ß‡∏¢', unit: '‡∏Ç‡∏ß‡∏î', type:'number' },
  { name: '‡∏≠‡∏±‡∏ç‡∏ä‡∏±‡∏ô', unit: '‡∏Ç‡∏ß‡∏î', type:'number' },
  { name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢', unit: '‡∏Ç‡∏ß‡∏î', type:'number' },
  { name: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏∞‡∏•‡∏¥', unit: '‡∏Ç‡∏ß‡∏î', type:'number' },
];

    // ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)
    function closeModeItemsForBranch(branch){
      const packagingReceipts =
        (branch === '‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏™‡∏±‡∏à‡∏à‡∏≤')
          ? [
              { name:'‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÉ‡∏´‡∏ç‡πà)', unit:'‡∏°‡πâ‡∏ß‡∏ô', category:'packaging', icon:'üì¶', orderOnly:true },
              { name:'‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏•‡πá‡∏Å)',  unit:'‡∏°‡πâ‡∏ß‡∏ô', category:'packaging', icon:'üì¶', orderOnly:true },
            ]
          : [
              { name:'‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', unit:'‡∏°‡πâ‡∏ß‡∏ô', category:'packaging', icon:'üì¶', orderOnly:true },
            ];

      return [
        // fresh
        { name:'‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏°‡∏µ‡πà', unit:'‡∏´‡πà‡∏≠', category:'fresh', icon:'ü•¨', type:'fraction' },
        { name:'‡∏≠‡∏Å‡πÑ‡∏Å‡πà', unit:'‡∏Å‡∏¥‡πÇ‡∏•', category:'fresh', icon:'ü•¨', type:'free' },
        { name:'‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏à‡∏Å', unit:'‡∏ñ‡∏∏‡∏á', category:'fresh', icon:'ü•¨', type:'fraction' },
        { name:'‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°', unit:'‡∏Å‡∏¥‡πÇ‡∏•', category:'fresh', icon:'ü•¨', type:'free' },
        { name:'‡πÉ‡∏ö‡∏û‡∏≤‡∏™‡πÄ‡∏•‡πà‡∏¢‡πå', unit:'‡∏ñ‡∏∏‡∏á', category:'fresh', icon:'ü•¨', type:'fraction' },
        { name:'‡∏•‡∏π‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏õ‡∏•‡∏≤', unit:'', category:'fresh', icon:'ü•¨', orderOnly:true },
        { name:'‡πÑ‡∏Ç‡πà‡∏Å‡∏∏‡πâ‡∏á', unit:'', category:'fresh', icon:'ü•¨', orderOnly:true },

        // seasoning
        { name:'‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', unit:'‡πÅ‡∏Å‡∏•‡∏•‡∏≠‡∏ô', category:'seasoning', icon:'üßÇ', type:'fraction' },
        { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', unit:'‡∏Å‡∏£‡∏±‡∏°', category:'seasoning', icon:'üßÇ', type:'free' },
        { name:'‡∏ã‡∏≠‡∏™‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°', unit:'‡πÅ‡∏Å‡∏•‡∏•‡∏≠‡∏ô', category:'seasoning', icon:'üßÇ', type:'fraction' },
        { name:'‡∏ô‡πâ‡∏≥‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', unit:'‡∏Ç‡∏ß‡∏î', category:'seasoning', icon:'üßÇ', orderOnly:true },
        { name:'‡∏û‡∏£‡∏¥‡∏Å‡∏õ‡πà‡∏ô', unit:'‡∏ñ‡∏∏‡∏á', category:'seasoning', icon:'üßÇ', orderOnly:true },
        { name:'‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•', unit:'‡∏ñ‡∏∏‡∏á', category:'seasoning', icon:'üßÇ', orderOnly:true },
        { name:'‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤', unit:'‡∏Ç‡∏ß‡∏î', category:'seasoning', icon:'üßÇ', orderOnly:true },
        { name:'‡∏£‡∏™‡∏î‡∏µ', unit:'‡∏ñ‡∏∏‡∏á', category:'seasoning', icon:'üßÇ', orderOnly:true },

        // packaging + drinks
        { name:'‡∏ñ‡∏∏‡∏á‡∏ã‡∏µ‡∏• 7√ó10', unit:'‡∏´‡πà‡∏≠', category:'packaging', icon:'üì¶', type:'fraction' },
        { name:'‡∏ñ‡∏∏‡∏á‡∏ã‡∏µ‡∏• 9√ó11.5', unit:'‡∏´‡πà‡∏≠', category:'packaging', icon:'üì¶', type:'fraction' },
        { name:'‡∏Å‡∏•‡πà‡∏≠‡∏á 26 oz', unit:'‡πÅ‡∏ñ‡∏ß', category:'packaging', icon:'üì¶', type:'fraction' },
        { name:'‡∏Å‡∏•‡πà‡∏≠‡∏á 32 oz', unit:'‡πÅ‡∏ñ‡∏ß', category:'packaging', icon:'üì¶', type:'fraction' },
        { name:'‡∏ñ‡∏∏‡∏á‡∏´‡∏¥‡πâ‡∏ß‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å 6√ó14', unit:'‡∏´‡πà‡∏≠', category:'packaging', icon:'üì¶', type:'fraction' },
        { name:'‡∏ñ‡∏∏‡∏á‡∏´‡∏¥‡πâ‡∏ß‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å 8√ó16', unit:'‡∏´‡πà‡∏≠', category:'packaging', icon:'üì¶', type:'fraction' },
        { name:'‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°', unit:'‡πÅ‡∏ú‡πà‡∏ô', category:'packaging', icon:'üì¶', type:'fraction' },
        { name:'‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡πÅ‡∏ã‡πà‡∏ö', unit:'‡πÅ‡∏ú‡πà‡∏ô', category:'packaging', icon:'üì¶', type:'fraction' },
        { name:'‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤', unit:'‡∏Ç‡∏ß‡∏î', category:'packaging', icon:'üì¶', type:'number' },
        { name:'‡∏ô‡πâ‡∏≥‡πÇ‡∏Ñ‡πâ‡∏Å', unit:'‡∏Ç‡∏ß‡∏î', category:'packaging', icon:'üì¶', type:'number' },
        { name:'‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°', unit:'‡∏Ç‡∏ß‡∏î', category:'packaging', icon:'üì¶', type:'number' },
        { name:'‡∏ô‡πâ‡∏≥‡πÅ‡∏î‡∏á', unit:'‡∏Ç‡∏ß‡∏î', category:'packaging', icon:'üì¶', type:'number' },
        { name:'‡∏ô‡πâ‡∏≥‡∏™‡πÑ‡∏õ‡∏£‡πå‡∏ó', unit:'‡∏Ç‡∏ß‡∏î', category:'packaging', icon:'üì¶', type:'number' },
        { name:'‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡πä‡∏Å‡∏Æ‡∏ß‡∏¢', unit:'‡∏Ç‡∏ß‡∏î', category:'packaging', icon:'üì¶', type:'number' },
        { name:'‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ç‡∏ä‡∏±‡∏ô', unit:'‡∏Ç‡∏ß‡∏î', category:'packaging', icon:'üì¶', type:'number' },
        { name:'‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢', unit:'‡∏Ç‡∏ß‡∏î', category:'packaging', icon:'üì¶', type:'number' },
        ...packagingReceipts,
        { name:'‡∏ï‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏ö', unit:'', category:'packaging', icon:'üì¶', orderOnly:true },

        // cleaning (order-only checkboxes)
        { name:'‡∏ñ‡∏∏‡∏á‡∏Ç‡∏¢‡∏∞', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
        { name:'‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
        { name:'‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà‡πÅ‡∏´‡πâ‡∏á', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
        { name:'‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏ñ‡∏π‡∏û‡∏∑‡πâ‡∏ô', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
        { name:'‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
        { name:'‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏ô', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
        { name:'‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏ô', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
        { name:'‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
        { name:'‡∏´‡∏°‡∏ß‡∏Å‡∏Ñ‡∏•‡∏∏‡∏°‡∏ú‡∏°', unit:'', category:'cleaning', icon:'üßπ', orderOnly:true },
      ];
    }

    /* ---------------- Navigation ---------------- */
    function selectBranch(branch){
      currentBranch = branch;
      document.getElementById('selectedBranch').textContent = branch;
      showScreen('modeScreen');
    }
    function selectMode(mode){
      currentMode = mode;
      document.getElementById('modeText').textContent = mode === 'open' ? 'üîì ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô' : 'üåô ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô';
      loadStockItems();
      showScreen('stockScreen');
    }
    function showScreen(id){
      ['branchScreen','modeScreen','stockScreen','summaryScreen'].forEach(s => {
        document.getElementById(s).classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
    }
    function goBack(id){ showScreen(id); }

    /* ---------------- Render items ---------------- */
    function loadStockItems(){
      const container = document.getElementById('stockItems');
      container.innerHTML = '';
      stockData = {};
      orderRequests = {};
      customOrders = [];

      if (currentMode === 'close') {
        const items = closeModeItemsForBranch(currentBranch);
        const categories = {
          fresh:     { name:'‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏î', color:'green',  icon:'ü•¨', items:[] },
          seasoning: { name:'‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á', color:'yellow', icon:'üßÇ', items:[] },
          packaging: { name:'‡∏´‡∏°‡∏ß‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå + ‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°/‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°', color:'blue', icon:'üì¶', items:[] },
          cleaning:  { name:'‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î', color:'purple', icon:'üßπ', items:[] },
        };
        items.forEach(it => categories[it.category].items.push(it));

        Object.values(categories).forEach(cat => {
          if (cat.items.length === 0) return;
          const wrap = document.createElement('div');
          wrap.className = 'mb-6';
          wrap.innerHTML = `
            <div class="flex items-center mb-4">
              <span class="text-2xl mr-2">${cat.items[0].icon}</span>
              <h3 class="text-lg font-semibold text-gray-800">${cat.name}</h3>
            </div>
          `;
          cat.items.forEach(it => wrap.appendChild(createItemElement(it)));
          container.appendChild(wrap);
        });

        // ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡πÄ‡∏û‡∏¥‡πà‡∏°
        const customDiv = document.createElement('div');
        customDiv.className = 'mb-6';
        customDiv.innerHTML = `
          <div class="flex items-center mb-4">
            <span class="text-2xl mr-2">üìù</span>
            <h3 class="text-lg font-semibold text-gray-800">‡∏™‡∏±‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡πÄ‡∏û‡∏¥‡πà‡∏°</h3>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <input type="text" id="customItemName" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏û‡∏™‡∏≠‡∏¥‡∏ó ‡∏™‡∏Å‡πä‡∏≠‡∏ï‡πÄ‡∏ó‡∏õ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                  onkeypress="if(event.key==='Enter') addCustomOrder()">
                <button onclick="addCustomOrder()" class="bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600 transition-colors">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
              </div>
              <div id="customOrdersList" class="space-y-2"></div>
            </div>
          </div>
        `;
        container.appendChild(customDiv);
      } else {
        // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)
        openModeItemsBase.forEach(it => container.appendChild(createItemElement({ ...it })));
      }

      updateProgress();
    }

    function createItemElement(item){
      const div = document.createElement('div');
      div.className = 'bg-white rounded-xl p-4 mb-3 shadow-sm border border-gray-100';

      // order-only (checkbox + ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
      if (item.orderOnly) {
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-medium text-gray-800">${item.name}</h4>
              <p class="text-sm text-gray-500">‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</p>
            </div>
            <label class="flex items-center">
              <input type="checkbox" class="w-5 h-5 text-orange-500 rounded" onchange="toggleOrderRequest('${item.name}', this.checked, this)">
              <span class="ml-2 text-sm text-gray-600">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
            </label>
          </div>
        `;
        return div;
      }

      // type: fraction ‚Üí select 0‚Äì6 + ‡πÄ‡∏®‡∏©
      if (item.type === 'fraction') {
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-medium text-gray-800">${item.name}</h4>
            </div>
            <div class="flex items-center space-x-3">
              <div class="flex items-center space-x-2">
                <select class="w-16 px-2 py-2 border border-gray-300 rounded-lg text-center font-medium"
                  onchange="updateFractionStock('${item.name}', this)">
                  ${Array.from({length: WHOLE_MAX+1}, (_,i)=>`<option value="${i}">${i}</option>`).join('')}
                </select>
                <select class="w-16 px-2 py-2 border border-gray-300 rounded-lg text-center font-medium"
                  onchange="updateFractionStock('${item.name}', this)">
                  ${FRACTIONS.map(fr => `<option value="${fr}">${fr || '-'}</option>`).join('')}
                </select>
                <span class="text-sm text-gray-600">${item.unit}</span>
              </div>
              ${currentMode === 'close' ? getOrderBtnHTML(item.name) : ''}
            </div>
          </div>
        `;
        return div;
      }

      // type: number ‚Üí input number (0‚Äì6)
      if (item.type === 'number') {
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-medium text-gray-800">${item.name}</h4>
            </div>
            <div class="flex items-center space-x-3">
              <div class="flex items-center space-x-2">
                <input type="number" min="0" max="${WHOLE_MAX}" step="1"
                  class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center font-medium"
                  placeholder="0" oninput="clampNumber(this)" onchange="updateStock('${item.name}', this.value)">
                <span class="text-sm text-gray-600">${item.unit}</span>
              </div>
              ${currentMode === 'close' ? getOrderBtnHTML(item.name) : ''}
            </div>
          </div>
        `;
        return div;
      }
      
// type: free ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÑ‡∏î‡πâ), ‡πÑ‡∏°‡πà‡∏°‡∏µ max
if (item.type === 'free') {
  div.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="flex-1">
        <h4 class="font-medium text-gray-800">${item.name}</h4>
      </div>
      <div class="flex items-center space-x-3">
        <div class="flex items-center space-x-2">
          <input type="number" min="0" step="any"
                 class="w-28 px-3 py-2 border border-gray-300 rounded-lg text-center font-medium"
                 placeholder="0" onchange="updateStock('${item.name}', this.value)">
          <span class="text-sm text-gray-600">${item.unit}</span>
        </div>
        ${currentMode === 'close' ? getOrderBtnHTML(item.name) : ''}
      </div>
    </div>
  `;
  return div;
}

      return div;
    }

    function clampNumber(inp){
      const v = parseInt(inp.value || '0', 10);
      if (isNaN(v) || v < 0) inp.value = 0;
      else if (v > WHOLE_MAX) inp.value = WHOLE_MAX;
    }

    // fraction updater: ‡πÉ‡∏ä‡πâ selects ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    function updateFractionStock(itemName, el){
      const parent = el.parentNode;
      const selects = parent.querySelectorAll('select');
      if (selects.length === 2){
        const whole = selects[0].value;
        const frac  = selects[1].value;
        let val = whole;
        if (frac && whole !== '0') val = `${whole} ${frac}`;
        else if (frac && whole === '0') val = frac;
        stockData[itemName] = val || '';
        updateProgress();
      }
    }

    function updateStock(name, value){
      stockData[name] = value || '';
      updateProgress();
    }

    /* ---------------- Order controls ---------------- */
    function toggleOrderRequest(itemName, checked, checkbox){
      if (checked) {
        currentConfirmItem = itemName;
        const nameEl  = document.getElementById('confirmItemName');
        const titleEl = document.getElementById('confirmModalTitle');
        titleEl.textContent = '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?';
        nameEl.textContent = itemName;
        nameEl.className = 'text-2xl font-extrabold tracking-wide mb-6 text-orange-600';
        window.currentAction = 'add';
        window.currentCheckbox = checkbox;
        document.getElementById('confirmModal').classList.remove('hidden');
      } else {
        delete orderRequests[itemName];
        updateProgress();
      }
    }

    function requestOrder(itemName){
      currentConfirmItem = itemName;
      const isOrdered = !!orderRequests[itemName];
      const nameEl  = document.getElementById('confirmItemName');
      const titleEl = document.getElementById('confirmModalTitle');

      titleEl.textContent = isOrdered ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?' : '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?';
      nameEl.textContent = itemName;
      nameEl.className = 'text-2xl font-extrabold tracking-wide mb-6 ' + (isOrdered ? 'text-red-600' : 'text-orange-600');
      window.currentAction = isOrdered ? 'remove' : 'add';

      document.getElementById('confirmModal').classList.remove('hidden');
    }

    function confirmOrder(){
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ closeModal() ‡∏à‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
  const item = currentConfirmItem;

  if (window.currentAction === 'remove') {
    delete orderRequests[item];
  } else {
    orderRequests[item] = true;
  }

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡∏™‡πâ‡∏° ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•
  refreshOrderButtonState(item);
  updateProgress();

  // ‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
  closeModal();
}
    
    function closeModal(){
  const item = currentConfirmItem; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô

  document.getElementById('confirmModal').classList.add('hidden');

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏¥‡πä‡∏Å checkbox ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å‡∏Å‡∏•‡∏±‡∏ö
  if (window.currentCheckbox && window.currentAction === 'add' && !orderRequests[item]) {
    window.currentCheckbox.checked = false;
  }

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  window.currentCheckbox = null;
  currentConfirmItem = '';
  window.currentAction = null;
}

    /* ---------------- Progress ---------------- */
    function updateProgress(){
      const items = currentMode === 'open' ? openModeItemsBase : closeModeItemsForBranch(currentBranch);
      let completed = 0;
      items.forEach(it => {
        if (it.orderOnly) {
          completed++; // ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏™‡∏°‡∏≠ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)
        } else {
          if (stockData[it.name] && stockData[it.name] !== '') completed++;
        }
      });
      const pct = Math.round((completed / items.length) * 100);
      document.getElementById('progressText').textContent = pct + '%';
      document.getElementById('progressBar').style.width = pct + '%';
    }

    /* ---------------- Save / Summary / Telegram ---------------- */
    function saveStock(){
      if (currentMode === 'open') {
        confirmSaveStock(); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ
      } else {
        showOrderSummary();
        showScreen('summaryScreen');
      }
    }

    function showOrderSummary(){
      const wrap = document.getElementById('orderSummaryList');
      wrap.innerHTML = '';
      const list = Object.keys(orderRequests).filter(n => orderRequests[n]);
      if (customOrders.length) list.push(...customOrders.map(o=>o.name));

      if (list.length === 0) {
        wrap.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">üìù</div>
            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</p>
          </div>`;
        return;
      }

      list.forEach((name, i) => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0';
        row.innerHTML = `
          <div class="flex items-center">
            <span class="w-8 h-8 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-sm font-medium mr-3">${i+1}</span>
            <span class="font-medium text-gray-800">${name}</span>
          </div>
          <span class="text-green-600 font-medium">‚úì ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
        `;
        wrap.appendChild(row);
      });
    }

    function confirmSaveStock(){
      const now = new Date();
      const report = {
        branch: currentBranch,
        mode: currentMode, // 'open' | 'close'
        date: now.toLocaleDateString('th-TH'),
        time: now.toLocaleTimeString('th-TH'),
        progress: parseInt(document.getElementById('progressText').textContent) || 0,
        stocks: buildStocksPayload(),     // [{name,value,unit}]
        orders: buildOrdersPayload(),     // [string]
      };

      // ‡∏™‡πà‡∏á‡πÑ‡∏õ Netlify Function ‚Üí Telegram (‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ)
      fetch('/api/telegram', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(report)
      }).catch(()=>{ /* ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå */ });

      document.getElementById('successModal').classList.remove('hidden');
    }

    function buildStocksPayload(){
      // ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô orderOnly
      const allItems = currentMode === 'open' ? openModeItemsBase : closeModeItemsForBranch(currentBranch);
      const names = new Set(allItems.filter(i => !i.orderOnly).map(i => i.name));
      return Object.entries(stockData)
        .filter(([name,val]) => names.has(name) && val && String(val).trim() !== '')
        .map(([name,val]) => {
          const unit = (allItems.find(i => i.name === name) || {}).unit || '';
          return { name, value: val, unit };
        });
    }

    function buildOrdersPayload(){
      const listed = Object.keys(orderRequests).filter(n => orderRequests[n]);
      if (customOrders.length) listed.push(...customOrders.map(o=>o.name));
      return listed;
    }

    /* ---------------- Custom orders ---------------- */
    function addCustomOrder(){
      const inp = document.getElementById('customItemName');
      const name = (inp.value || '').trim();
      if (!name) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }
      if (customOrders.some(o => o.name === name)) { alert('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return; }
      const item = { id: Date.now(), name };
      customOrders.push(item);
      orderRequests[name] = true;
      inp.value = '';
      updateCustomOrdersList();
      updateProgress();
    }
    function removeCustomOrder(id){
      const idx = customOrders.findIndex(o => o.id === id);
      if (idx !== -1){
        const name = customOrders[idx].name;
        delete orderRequests[name];
        customOrders.splice(idx, 1);
        updateCustomOrdersList();
        updateProgress();
      }
    }
    function updateCustomOrdersList(){
      const wrap = document.getElementById('customOrdersList');
      if (!wrap) return;
      wrap.innerHTML = '';
      customOrders.forEach(o => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-green-50 p-3 rounded-lg border border-green-200';
        row.innerHTML = `
          <div class="flex-1"><span class="font-medium text-green-800">${o.name}</span></div>
          <button onclick="removeCustomOrder(${o.id})" class="text-red-500 hover:text-red-700 text-sm font-medium">‡∏•‡∏ö</button>`;
        wrap.appendChild(row);
      });
    }

    /* ---------------- Reset ---------------- */
    function resetApp(){
      currentBranch=''; currentMode='';
      stockData={}; orderRequests={}; customOrders=[];
      document.getElementById('successModal').classList.add('hidden');
      showScreen('branchScreen');
    }

    // init
    showScreen('branchScreen');
  </script>
</body>
</html>


